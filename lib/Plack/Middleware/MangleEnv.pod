=pod

=encoding utf8

=head1 NAME

Plack::Middleware::MangleEnv - Mangle request environment at will

=head1 VERSION

This document describes Plack::Middleware::MangleEnv version {{[ version
]}}.

=head1 SYNOPSIS

   use Plack::Middleware::MangleEnv;

   my $mw = Plack::Middleware::MangleEnv->new(

      # overriding is the default behaviour

      # straight value, must be a plain SCALAR (no refs)
      var_name    => 'a simple, overriding value',

      # any value can be wrapped, even refs
      some_value  => [ \@whatever ],

      # or you can be just explicit
      alternative => { value => $whatever },

      # you can read stuff from %ENV
      from_ENV    => { ENV => 'PLACK_ENV' },

      # or read other variables from $env
      from_env    => { env => 'psgi.url_scheme' },

      # turn override into defaulting, works with value, env and ENV
      de_fault    => { value => $something, override => 0 },

      # get rid of a variable, inconditionally. You can pass "no value"
      # or be explicit about your intent
      delete_pliz => [],
      delete_me   => { remove => 1 },

      # use subroutines for maximum flexibility.
      change_me1  => sub { ... },
      change_me2  => { sub => sub { ... } },

   );

   # you can also pass the key/value pairs as a hash reference
   # associated to a key named 'manglers'. This is necessary if you want
   # e.g. to set a variable in $env with name 'app' (or 'manglers'
   # itself)
   my $mw2 = Plack::Middleware::MangleEnv->new(
      manglers => {
         what => 'EVER',
         who  => 'are you?',
      }
   );

   # when evaluation order or repetition is important... use an array
   # reference for 'manglers'
   my $mw3 = Plack::Middleware::MangleEnv->new(
      manglers => [
         same_as => 'before', # set this at the beginning...
         what => {env => 'same_as'},
         ...,
         same_as => [], # ... and delete this at the end
      ]
   );

=head1 DESCRIPTION

This module allows you to mangle L<Plack>'s C<$env> that is passed along
to the sequence of I<app>s, taking values from:

=over

=item *

direct configuration;

=item *

values from C<%ENV>;

=item *

other values in C<$env> itself;

=item *

subroutines.

=back

=head2 How Variables Are Set

The end goal of this middleware module is to manipulate C<$env> by
adding, changing or deleting its items.

You can pass the different actions to be performed as key-value pairs.
They can either appear directly upon invoking the middleware, as in the
following example:

   my $mw = Plack::Middleware::MangleEnv->new(
      var_name    => 'a simple, overriding value',
      some_value  => [ \@whatever ],
      alternative => { value => $whatever },
      # ... you get the idea
   );

or wrap these pairs inside either an hash or an array reference whose
key is C<manglers>, like in the following examples:

   my $mw_h = Plack::Middleware::MangleEnv->new(
      manglers => {
         var_name    => 'a simple, overriding value',
         some_value  => [ \@whatever ],
         alternative => { value => $whatever },
         # ... you get the idea
      }
   );

   my $mw_a = Plack::Middleware::MangleEnv->new(
      manglers => [
         var_name    => 'a simple, overriding value',
         some_value  => [ \@whatever ],
         alternative => { value => $whatever },
         # ... you get the idea
      ]
   );

Although more verbose, this last approach with an array reference is
important because it allows you to:

=over

=item *

define the exact order of evaluation for mangling actions;

=item *

define multiple actions for the same key, possibly at different stages;

=item *

use keys C<manglers> and C<app>, if you need them.

=back

There's a wide range of possible I<values> that you can set associated
to a key:

=over

=item B<< Simple scalar >>

   key => 'some simple, non-reference scalar',

a I<non-reference> scalar is always taken as-is and then set in C<$env>.

=item B<< Array reference >>

   key => [],
   key => [ { 'a non' => 'trivial scalar' } ],

when you pass an array reference, it can be either empty (in which case
the associated key will be I<removed> from C<$env>) or contain exactly
one value, which will be set into C<$env>.

This alternative allows you to set any scalar, not just non-reference
ones; so the following examples will do what they say:

   # set key to an array ref with numbers 1..3 inside
   key => [ [1..3] ], # note: array ref inside array ref!

   # set key to a hash reference, literally
   key => [ { a => 'b', c => 'd' } ],

   # set key to a sub reference, literally
   key => [ sub { 'I go with key!' } ],

=item B<< Sub reference >>

   key => sub { ... },

the sub reference will be called and its return value used to figure out
the value to associate to the key. See L</Sub Reference Interface> for
details on the expected interface for the sub;

=item B<< Hash reference >>

allows you to be I<verbosely clear> about what you want, in addition to
giving you knobs to modify the behaviour. The allowed keys are the
following:

=over

=item C<env>

points to a string that will be used to extract the value from C<$env>
itself. Useful if you want to I<change the name> of a parameter;

Can not appear together with either C<ENV> or C<value>, for obvious
reasons;

=item C<ENV>

points to a string that will be used to extract the value from C<%ENV>.
Useful if you want to get some variables from the environment, e.g. see
L</Example Scenario>.

Can not appear together with either C<env> or C<value>, for obvious
reasons;

=item C<override>

boolean flag that indicates whether the new value overrides a previous
one, if any. Set to a false value to avoid overriding an existing value,
while still being able to provide a default one if the key is missing
from C<$env>.

Defaults to a true value;

=item C<sub>

set a subroutine, see L</Sub Reference Interface> for details;

=item C<value>

set a value that is not a simple plain scalar:

   # set key to an array ref with numbers 1..3 inside
   key => { value => [1..3] },

   # set key to a hash reference, literally
   key => { value => { a => 'b', c => 'd' } }, # note: hash in hash!

   # set key to a sub reference, literally
   key => { value => sub { 'I go with key!' } },

=back

Exactly one of the keys C<env>, C<ENV>, C<sub> and C<value> MUST appear
in the hash reference. For obvious reasons, you cannot provide more of
them, otherwise a conflict would arise.

=back


=head2 Sub Reference Interface

The most flexible way to mangle C<$env> is through a subroutine. It can
be provided either directly associated to the key, or through the C<sub>
sub-key in the hash associated to the key.

The provided subroutine reference will be called like this:

   sub {
      my ($current_value, $env, $key) = @_;
      # do what you need
      return @something;
   }

The I<sub> can modify C<$env> at will, e.g. by adding new keys or
removing other ones based on your specific logic.

If you don't return anything, or the C<undef> value, the corresponding
C<$key> in C<$env> will be left untouched, keeping its previous value
(if any).  Otherwise, you are supposed to return one single value that
can be:

=over

=item *

B<not> an array reference, in which case it is used as the value
associated to C<$key> in C<$env>;

=item *

an array reference. If the array is empty, the C<$key> is removed from
C<$env>; otherwise, it MUST contain exactly one value, used to set the
key C<$key> in C<$env> (which also allows you to set as output an array
reference, even an empty one).

=back

Examples:

   # nothing happens with this
   sub { return }

   # key is removed from $env
   sub { return [] }

   # key is set to an empty array in $env
   sub { return [[]] }


=head1 METHODS

=head2 Plack-related

The following methods are implemented as part of the interface for a
Plack middleware.

=over

=item call

=item prepare_app

=back


=head1 BUGS AND LIMITATIONS

Report bugs either through RT or GitHub (patches welcome).

=head1 SEE ALSO

L<Plack>, L<Plack::Middleware::ForceEnv>,
L<Plack::Middleware::SetLocalEnv>,
L<Plack::Middleware::SetEnvFromHeader>.

=head1 AUTHOR

Flavio Poletti <polettix@cpan.org>

=head1 COPYRIGHT AND LICENSE

Copyright (C) 2016 by Flavio Poletti <polettix@cpan.org>

This module is free software. You can redistribute it and/or modify it
under the terms of the Artistic License 2.0.

This program is distributed in the hope that it will be useful, but
without any warranty; without even the implied warranty of
merchantability or fitness for a particular purpose.

=cut
